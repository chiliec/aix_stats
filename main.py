from datetime import datetime
import json
from web3 import Web3
from dotenv import dotenv_values

# Load variables from .env file into a dictionary
env_vars = dotenv_values(".env")

# Connect to the Ethereum node
w3 = Web3(Web3.HTTPProvider(env_vars["WEB3_HTTP_PROVIDER"]))

# Contract address
contract_address = "0xaBE235136562a5C2B02557E1CaE7E8c85F2a5da0"
# ABI (Application Binary Interface) of the contract
contract_abi = json.loads(
    """[{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"value","type":"bool"}],"name":"AnyoneCanDistributeSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Distributed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"version","type":"uint8"}],"name":"Initialized","type":"event"},{"anonymous":false,"inputs":[{"components":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"indexed":false,"internalType":"struct AIXTreasury.Receiver[]","name":"aixReceivers","type":"tuple[]"},{"components":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"indexed":false,"internalType":"struct AIXTreasury.Receiver[]","name":"ethReceivers","type":"tuple[]"}],"name":"ReceiversSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"aixAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"}],"name":"TokensSwapped","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"inputAixAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"distributedAixAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"swappedEthAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"distributedEthAmount","type":"uint256"}],"name":"TotalDistribution","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"TransferETH","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DENOMINATOR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DISTRIBUTOR_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"aix","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"aixReceivers","outputs":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"anyoneCanDistribute","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"minETHPerAIXPrice","type":"uint256"}],"name":"distribute","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ethReceivers","outputs":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IERC20","name":"_aix","type":"address"},{"internalType":"address","name":"_uniswapRouter","type":"address"},{"internalType":"address","name":"_weth","type":"address"},{"components":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"internalType":"struct AIXTreasury.Receiver[]","name":"_aixReceivers","type":"tuple[]"},{"components":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"internalType":"struct AIXTreasury.Receiver[]","name":"_ethReceivers","type":"tuple[]"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"value","type":"bool"}],"name":"setAnyoneCanDistribute","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"internalType":"struct AIXTreasury.Receiver[]","name":"_aixReceivers","type":"tuple[]"},{"components":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bool","name":"doCallback","type":"bool"}],"internalType":"struct AIXTreasury.Receiver[]","name":"_ethReceivers","type":"tuple[]"}],"name":"setReceivers","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalAixShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalEthShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"uniswapRouter","outputs":[{"internalType":"contract IUniswapV2Router02","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"weth","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}]"""
)

# Create a contract instance
contract = w3.eth.contract(address=contract_address, abi=contract_abi)

# Get the block number of 24 hours ago
block_number_24h_ago = (
    w3.eth.getBlock("latest").number - 5760
)  # Assuming 15 seconds per block

# Get all logs for the contract's events in the last 24 hours
logs = w3.eth.getLogs(
    {
        "address": contract_address,
        "fromBlock": block_number_24h_ago,
        "toBlock": "latest",
        "topics": [Web3.sha3(text="TotalDistribution()").hex()],
    }
)

# Parse hexadecimal data to array
values_array = []
for log in logs:
    event = contract.events.TotalDistribution().processLog(log)
    value_hex = event["args"]["value"].hex()
    # Convert hexadecimal string to array of decimal values
    values_array.extend(
        [int(value_hex[i : i + 2], 16) for i in range(0, len(value_hex), 2)]
    )

print("Values array:", values_array)
